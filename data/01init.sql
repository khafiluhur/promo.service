-- Check if 'demo' database exists; if not, create it
CREATE DATABASE IF NOT EXISTS promo CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;

-- Use the 'demo' database
USE promo;

CREATE TABLE IF NOT EXISTS `promo_code` (
  `id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `name` VARCHAR(255) NOT NULL COMMENT 'Promo Name',
  `description` VARCHAR(255) DEFAULT NULL COMMENT 'Promo Description',
  `termCondition` VARCHAR(255) DEFAULT NULL COMMENT 'Promo Term & Condition',
  `startDate` INT(10) UNSIGNED NOT NULL COMMENT 'Promo Start Date (unix timestamp)',
  `endDate` INT(10) UNSIGNED NOT NULL COMMENT 'Promo End Date (unix timestamp)',
  `banner` VARCHAR(255) DEFAULT NULL COMMENT 'Promo Banner URL',
  `rules` ENUM('otg','sp','pw') NOT NULL COMMENT 'Promo Rules: otg|sp|pw',
  `amount` DECIMAL(13,2) DEFAULT NULL COMMENT 'Amount for OTG rule (order total threshold)',
  `productSlug` VARCHAR(255) DEFAULT NULL COMMENT 'Product slug for SP rule',
  `paymentMethod` VARCHAR(100) DEFAULT NULL COMMENT 'Payment method identifier for PW rule',
  `promoAction` ENUM('fixed','percent') NOT NULL COMMENT 'Promo action: fixed or percent',
  `discountAmount` DECIMAL(13,2) DEFAULT NULL COMMENT 'Discount amount (fixed or percent value)',
  `promoType` VARCHAR(255) NOT NULL COMMENT 'Promo type e.g. pax, total',
  `type` VARCHAR(255) NOT NULL COMMENT 'Category type e.g. tour, flight, hotel',
  `promoCode` VARCHAR(255) NOT NULL COMMENT 'Promo code (unique)',
  `customerLimit` INT(10) DEFAULT NULL COMMENT 'Customer limit',
  `newCustomer` TINYINT(3) UNSIGNED NOT NULL DEFAULT 0 COMMENT 'New customer only flag (1 = yes)',
  `quantity` INT(10) NOT NULL DEFAULT 0 COMMENT 'Promo quantity/stock',
  `is_active` tinyint(1) NOT NULL COMMENT '0: NOT ACTIVE, 1: ACTIVE',
  `specialPromo` INT(10) UNSIGNED DEFAULT NULL COMMENT 'Special promo indicator',
  `isDisplay` TINYINT(3) UNSIGNED NOT NULL DEFAULT 1 COMMENT 'Is display flag',
  `platform` VARCHAR(50) NOT NULL COMMENT 'Platform name',
  `created_at` BIGINT(20) UNSIGNED NOT NULL DEFAULT 0,
  `created_by` BIGINT(20) UNSIGNED NOT NULL DEFAULT 0,
  `updated_at` BIGINT(20) UNSIGNED NOT NULL DEFAULT 0,
  `updated_by` BIGINT(20) UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `promoCode_unique` (`promoCode`),
  KEY `idx_promoIsActive` (`is_active`),
  KEY `idx_platform` (`platform`),
  KEY `idx_combine_v1` (`id`,`is_active`,`type`,`platform`),
  KEY `idx_promoType` (`type`),
  FULLTEXT KEY `idx_fulltext_name` (`name`),
  INDEX `idx_promo_id` (`id` ASC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

CREATE TABLE IF NOT EXISTS `strike_throught_price` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `description` varchar(255) DEFAULT NULL COMMENT 'Promo Description',
  `product_slug` varchar(255) DEFAULT NULL COMMENT 'Product Slug',
  `departure` INT DEFAULT NULL COMMENT 'Product Departure (opsional)',
  `termCondition` varchar(255) DEFAULT NULL COMMENT 'Promo Term & Condition',
  `startDate` int(10) unsigned NULL COMMENT 'Promo Start Date',
  `endDate` int(10) unsigned NULL COMMENT 'Promo End Date',
  `promoAction` ENUM('fixed', 'percent') NOT NULL COMMENT 'Promo Action',
  `type` varchar(255) NOT NULL COMMENT 'Type e.g tour, flight, hotel, etc',
  `is_active` tinyint(1) NOT NULL COMMENT '0: NOT ACTIVE, 1: ACTIVE',
  `platform` varchar(50) DEFAULT NULL COMMENT 'Platform name',
  `created_at`   bigint(20) UNSIGNED                            NOT NULL,
  `created_by`   bigint(20) UNSIGNED                            NOT NULL,
  `updated_at`   bigint(20) UNSIGNED                            NOT NULL,
  `updated_by`   bigint(20) UNSIGNED                            NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_promoIsActive` (`is_active`) USING HASH,
  KEY `idx_promoId` (`id`) USING HASH,
  KEY `idx_platform` (`platform`) USING HASH,
  KEY `idx_combine_v1` (
    `id`,
    `is_active`,
    `type`,
    `platform`
  ) USING HASH,
  KEY `idx_promoType` (`type`) USING HASH,
  FULLTEXT KEY `idx_fulltext_name` (`name`),
  INDEX `idx_promo_id` (`id` ASC)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_general_ci;

CREATE TABLE IF NOT EXISTS `promo_code_used` (
  `id` BIGINT(20) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `promo_code_id` INT(10) UNSIGNED NOT NULL COMMENT 'FK to promo_code.id',
  `promo_code` VARCHAR(255) NOT NULL COMMENT 'Promo code string (redundant copy for easier query)',
  `customer_id` BIGINT(20) UNSIGNED NOT NULL COMMENT 'Customer/User ID who used the promo',
  `order_id` BIGINT(20) UNSIGNED DEFAULT NULL COMMENT 'Related order ID (if applicable)',
  `platform` VARCHAR(50) NOT NULL COMMENT 'Platform name (same as promo_code.platform)',
  `discount_amount` DECIMAL(13,2) DEFAULT NULL COMMENT 'Actual discount applied',
  `order_total` DECIMAL(13,2) DEFAULT NULL COMMENT 'Order total before discount',
  `status` ENUM('used', 'cancelled', 'refunded') NOT NULL DEFAULT 'used' COMMENT 'Usage status',
  `used_at` BIGINT(20) UNSIGNED NOT NULL COMMENT 'When the promo was used (unix timestamp)',
  `created_at` BIGINT(20) UNSIGNED NOT NULL DEFAULT 0,
  `updated_at` BIGINT(20) UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  FOREIGN KEY (promo_code_id) REFERENCES promo_code (id) ON DELETE CASCADE,
  KEY `idx_promo_code_id` (`promo_code_id`),
  KEY `idx_customer_id` (`customer_id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_platform` (`platform`),
  KEY `idx_status` (`status`)
) ENGINE = InnoDB DEFAULT CHARSET= utf8mb4 COLLATE = utf8mb4_general_ci;

INSERT INTO `promo_code` (
  `id`,
  `name`,
  `description`,
  `termCondition`,
  `startDate`,
  `endDate`,
  `banner`,
  `rules`,
  `amount`,
  `productSlug`,
  `paymentMethod`,
  `promoAction`,
  `discountAmount`,
  `promoType`,
  `type`,
  `promoCode`,
  `customerLimit`,
  `newCustomer`,
  `quantity`,
  `is_active`,
  `specialPromo`,
  `isDisplay`,
  `platform`,
  `created_at`,
  `created_by`,
  `updated_at`,
  `updated_by`
) VALUES
-- 1️⃣ Order Total Greater (OTG)
(1,
 'Diskon Akhir Tahun',
 'Dapatkan potongan Rp100.000 untuk transaksi minimal Rp1.000.000',
 'Hanya berlaku untuk semua produk, 1x penggunaan per user',
 1761701974, -- 2025-10-29
 1764380374, -- 2025-11-29
 'https://cdn.example.com/banner/akhir-tahun.jpg',
 'otg',
 1000000.00,
 NULL,
 NULL,
 'fixed',
 100000.00,
 'total',
 'hotel',
 'AKHIRTAHUN100',
 1,
 0,
 1000,
 1,
 NULL,
 1,
 'tripdeals',
 1730121600,
 1,
 1730121600,
 1
),

-- 2️⃣ Specific Product (SP)
(2,
 'Promo Quest Cikarang',
 'Diskon 20% untuk hotel Quest Prime Cikarang',
 'Berlaku hanya untuk hotel Quest Prime Cikarang by ASTON',
 1761701974,
 1764380374,
 'https://cdn.example.com/banner/quest-cikarang.jpg',
 'sp',
 NULL,
 'quest-prime-cikarang-by-aston',
 NULL,
 'percent',
 20.00,
 'pax',
 'hotel',
 'QUEST20',
 2,
 0,
 500,
 1,
 NULL,
 1,
 'tripdeals',
 1730121600,
 1,
 1730121600,
 1
),

-- 3️⃣ Payment With (PW)
(3,
 'Promo Bayar dengan BCA',
 'Diskon Rp50.000 untuk pembayaran menggunakan BCA Virtual Account',
 'Berlaku hanya untuk metode pembayaran BCA VA',
 1761701974,
 1764380374,
 'https://cdn.example.com/banner/bca-va.jpg',
 'pw',
 NULL,
 NULL,
 50.00,
 'fixed',
 50000.00,
 'total',
 'tour',
 'BCAVA50',
 1,
 0,
 300,
 1,
 NULL,
 1,
 'tripdeals',
 1730121600,
 1,
 1730121600,
 1
),

-- 4️⃣ New Customer Only
(4,
 'Promo Pengguna Baru',
 'Dapatkan potongan 10% untuk pengguna baru',
 'Berlaku untuk user yang belum pernah melakukan transaksi sebelumnya',
 1761701974,
 1764380374,
 'https://cdn.example.com/banner/new-user.jpg',
 'otg',
 0.00,
 NULL,
 NULL,
 'percent',
 10.00,
 'total',
 'flight',
 'WELCOME10',
 1,
 1,
 9999,
 1,
 NULL,
 1,
 'tripdeals',
 1730121600,
 1,
 1730121600,
 1
),

-- 5️⃣ Inactive / expired promo (for testing status filter)
(5,
 'Promo Expired',
 'Promo ini sudah tidak berlaku',
 'Hanya untuk testing status expired',
 1725000000,
 1726000000,
 'https://cdn.example.com/banner/expired.jpg',
 'otg',
 1000000.00,
 NULL,
 NULL,
 'fixed',
 50000.00,
 'total',
 'hotel',
 'EXPIRED50',
 1,
 0,
 10,
 0,
 NULL,
 0,
 'tripdeals',
 1725000000,
 1,
 1725000000,
 1
);
